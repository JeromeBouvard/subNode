"use strict";var subNode=angular.module("subNode",["ngResource","ngCookies","ngAnimate","pascalprecht.translate","LocalStorageModule","ui.state","restangular"]);subNode.config(["$stateProvider","$locationProvider","$urlRouterProvider",function(e,o,t){return t.otherwise("/"),e.state("subNode",{views:{mainView:{}}}).state("index",{parent:"subNode",url:"/",views:{"mainView@":{templateUrl:"partials/home.html",controller:"HomeCtrl"}}}).state("show",{parent:"subNode",url:"/show/:showId",views:{"mainView@":{templateUrl:"partials/show.html",controller:"ShowCtrl"}}}),o.html5Mode(!1)}]),subNode.controller("ConfigCtrl",["$scope","$rootScope","$translate","$rest",function(e,o,t){e.params.lang=t.uses(),e.params.password2=e.params.password,e.selectLangChange=function(){t.uses(e.params.lang)},e.languages=[{id:"fr",name:"FranÃ§ais"},{id:"en",name:"English"}],e.saveParams=function(){e.params.post().then(function(o){o?e.error=o:window.location.reload()})}}]),subNode.controller("HomeCtrl",["$scope","$translate","Restangular","$loader",function(e,o,t,n){$("#selectedTVShow").val("").trigger("liszt:updated");var s=function(o){e.lastEpisodes=[],n.loading("home",!0),t.all("lastEpisodes/"+(o===!0)).getList().then(function(o){n.loading("home",!1),e.lastEpisodes=o})};s(),e.refresh=function(e){s(e)},e.copyright=o("COPYRIGHT")}]),subNode.controller("ShowCtrl",["$scope","$translate","Restangular","$stateParams","$loader","$timeout","$q",function(e,o,t,n,s,a,i){e.compact=!1,e.selectedEpisode={},e.subtitlesListShow=!1,e.showId=n.showId,e.showInfo=!1,e.hideOverview(),e.filter=function(o){e.seasonFilter=o,e.expand()},e.unsubs=function(e){return _.filter(e,{subtitle:void 0}).length},e.refresh=function(){e.show=null,t.one("show/"+n.showId).get().then(function(o){e.show=o,o.length>0&&(e.seasonFilter=o[o.length-1].season),e.showList.then(function(e){$("#selectedTVShow").val(e.indexOf(n.showId)).trigger("liszt:updated")})})},e.searchSubs=function(o){s.loading("subtitles",!0),e.compact=!0,e.loadingDone=!1,e.selectedEpisode=this.ep,$(".episode.active").removeClass("active"),$(o.currentTarget).addClass("active"),$(".seasonsList").addClass("col-lg-1").removeClass("col-lg-3"),$(".episodesList").addClass("col-lg-1").removeClass("col-lg-9"),a(function(){e.subtitlesListShow=!0},600),a(function(){$(".episodesList, .seasonsList").addClass("compacted")},750),e.subList=[];var r=[];if(-1!==e.params.providers.indexOf("addic7ed")){var l=t.one("addic7ed/"+n.showId+"/"+this.ep.name).get();l.then(function(o){o[0]&&o[0].content[0].episode===e.selectedEpisode.episode&&o[0].content[0].season===e.selectedEpisode.season&&(e.subList=e.subList.concat(o))}),r.push(l)}if(-1!==e.params.providers.indexOf("betaSeries")){var c=t.one("betaSeries/"+n.showId+"/"+this.ep.name).get();c.then(function(o){o[0]&&o[0].content[0].episode===e.selectedEpisode.episode&&o[0].content[0].season===e.selectedEpisode.season&&(e.subList=e.subList.concat(o))}),r.push(c)}i.all(r).then(function(){s.loading("subtitles",!1),e.loadingDone=!0})},e.downloadSub=function(o){s.loading("subtitles",!0),e.selectedEpisode.subtitle=this.sub,t.one("download").post("",{episode:e.selectedEpisode.file,url:this.subPack.url,subtitle:this.sub.file}).then(function(e){s.loading("subtitles",!1);var t=$(o.currentTarget).find(".name"),n=t.find("i");n.length>0&&n.remove(),e.success?(t.append(' <i class="success glyphicon glyphicon-ok"></i>'),$(".episode.active").addClass("alert-success")):t.append(' <i class="error glyphicon glyphicon-remove"></i>')})},e.expand=function(){s.loading("subtitles",!1),e.compact=!1,$(".seasonsList").addClass("col-lg-3").removeClass("col-lg-1"),$(".episodesList").addClass("col-lg-9").removeClass("col-lg-1"),$(".episode.active").removeClass("active"),e.subtitlesListShow=!1,a(function(){$(".episodesList, .seasonsList").removeClass("compacted")},750)},e.refresh(),a(function(){t.one("info/"+n.showId+"/"+o.uses()).get().then(function(o){e.showInfo=o})})}]),subNode.controller("SubnodeCtrl",["$scope","$state","Restangular","$timeout","$translate","$loader",function(e,o,t,n,s,a){e.safeApply=function(e){var o=this.$root.$$phase;"$apply"==o||"$digest"==o?e&&"function"==typeof e&&e():this.$apply(e)},t.one("params").get().then(function(o){e.params=o,"undefined"==typeof o.rootFolder&&e.openModal("partials/config.html")}),e.showList=t.all("showList").getList(),e.changeShow=function(){o.transitionTo("show",{showId:e.selectedTVShow})};var i=function(){t.one("checkUpdate").get().then(function(o){o.upToDate===!1?e.updateMsg=o:(e.updateMsg=!1,n(function(){i()},864e5))})};i(),e.updateApp=function(){a.loading("update",!0),e.updateError=!1,confirm(s("UPDATE_CONFIRM"))&&t.one("update").get().then(function(o){o.success?n(function(){a.loading("update",!1),window.location.reload()},5e3):(e.updateError=o,a.loading("update",!1))})}}]),subNode.directive("appVersion",["$version",function(e){return function(o,t){return t.text(e)}}]),subNode.directive("chosen",["$timeout",function(e){var o=/^\s*(.*?)(?:\s+as\s+(.*?))?(?:\s+group\s+by\s+(.*))?\s+for\s+(?:([\$\w][\$\w\d]*)|(?:\(\s*([\$\w][\$\w\d]*)\s*,\s*([\$\w][\$\w\d]*)\s*\)))\s+in\s+(.*)$/,t=["noResultsText","allowSingleDeselect","disableSearchThreshold","disableSearch","enableSplitWordSearch","inheritSelectClasses","maxSelectedOptions","placeholderTextMultiple","placeholderTextSingle","searchContains","singleBackstrokeDelete","displayDisabledOptions","displaySelectedOptions"],n=function(e){return e.replace(/[A-Z]/g,function(e){return"_"+e.toLowerCase()})},s=function(e){var o,t,n;if(angular.isArray(e))return 0===e.length;if(angular.isObject(e))for(t=0,n=e.length;n>t;t++)if(o=e[t],e.hasOwnProperty(o))return!1;return!0},a=[].indexOf||function(e){for(var o=0,t=this.length;t>o;o++)if(o in this&&this[o]===e)return o;return-1};return{restrict:"A",link:function(i,r,l){var c,u,d=i.$eval(l.chosen)||{},p=function(){return r.addClass("loading").attr("disabled",!0).trigger("chosen:updated")},f=function(){return r.removeClass("loading").attr("disabled",!1).trigger("chosen:updated")},h=function(e){return r.empty().append("<option selected>"+e+"</option>").attr("disabled",!0).trigger("chosen:updated")};angular.forEach(l,function(e,o){return a.call(t,o)>=0?d[n(o)]=i.$eval(e):void 0}),l.ngOptions?(c=l.ngOptions.match(o),u=c[7],angular.isUndefined(i.$eval(u))&&p(),i.$watch(u,function(o,t){if(o!==t){if(f(),s(o))return h(d.no_results_text||"No values available");e(function(){return r.chosen(d)})}})):e(function(){return r.chosen(d)})}}}]),subNode.directive("imageFallback",function(){return{link:function(e,o,t){o.bind("error",function(){o.replaceWith("<h1>"+t.imageFallback+"</h1>")})}}}),subNode.directive("loader",[function(){return{restrict:"E",replace:!0,scope:"isolate",template:['<div class="loader" ng-show="isLoading">','<span class="loader-block"></span>','<span class="loader-block"></span>','<span class="loader-block"></span>','<span class="loader-block"></span>','<span class="loader-block"></span>','<span class="loader-block"></span>','<span class="loader-block"></span>','<span class="loader-block"></span>','<span class="loader-block"></span>',"</div>"].join(""),link:function(e,o,t){e.isLoading=t.loaderActive,e.$on("loading."+t.loaderId,function(o,t){e.isLoading=t})}}}]).factory("$loader",["$rootScope",function(e){var o={loadCount:{},isLoading:{},checkExists:function(e){"undefined"==typeof o.loadCount[e]&&(o.loadCount[e]=0,o.isLoading[e]=!1)},loading:function(t,n){_.each(t.split(" "),function(t){o.checkExists(t),n?o.loadCount[t]++:o.loadCount[t]>0&&o.loadCount[t]--,o.loadCount[t]>0&&!o.isLoading[t]?(o.isLoading[t]=!0,e.$broadcast("loading."+t,!0)):0==o.loadCount[t]&&o.isLoading[t]&&(o.isLoading[t]=!1,e.$broadcast("loading."+t,!1))})},stopLoading:function(t){o.checkExists(t),o.loadCount[t]=0,o.isLoading[t]=!1,e.$broadcast("loading."+t,!1)}};return o}]),subNode.directive("modal",["$rootScope","$controller","$location","$timeout",function(e,o,t,n){return{restrict:"E",replace:!0,template:['<div class="modal-wrapper fade-in" ng-show="modalShow">','<div class="modal-backdrop fade in"></div>','<div role="dialog" tabindex="-1" class="modal fade in">','<div class="modal-dialog">','<div class="modal-content" ng-include="modalView"></div>',"</div>","</div>","</div>"].join(""),link:function(s){var a=document.body.style.overflow,i={},r=function(){"function"==typeof i.onClose&&i.onClose(),s.callbacksList=[],s.modalView=""};s.$watch("modalShow",function(e){e?(document.body.style.overflow="hidden","function"==typeof i.onOpen&&i.onOpen(),i.closeOnEsc!==!1&&kd.ESC.press(function(){kd.ESC.unbindPress(),s.$apply(function(){s.modalShow=!1})})):(document.body.style.overflow=a,r())}),e.openModal=function(a){if("string"==typeof a&&(a={url:a}),"object"==typeof i){if(s.modalShow===!0&&a.url===i.url&&i.path!==t.path())return r(),n(function(){e.openModal(a)}),void 0;i=a,i.path=t.path(),s.modalShow=!0;var l=s.$on("$includeContentLoaded",function(e){i.scope=e.targetScope,"string"==typeof i.controller&&o(i.controller,{$scope:e.targetScope}),l()});s.modalView=i.url,"function"==typeof callback&&s.callbacksList.push(callback)}},e.closeModal=function(){s.modalShow=!1}}}}]).directive("modalOpen",["$rootScope",function(e){return{restrict:"A",link:function(o,t,n){t.on("click",function(t){t.preventDefault(),"string"==typeof n.modalOpen&&o.$apply(function(){e.openModal({url:n.modalOpen,controller:n.modalCtrl})})})}}}]),subNode.directive("ngBlur",["$parse",function(e){return function(o,t,n){var s=e(n.ngBlur);t.bind("blur",function(e){o.$apply(function(){s(o,{$event:e})})})}}]),subNode.directive("ngFocus",["$parse",function(e){return function(o,t,n){var s=e(n.ngFocus);t.bind("focus",function(e){o.$apply(function(){s(o,{$event:e})})})}}]),subNode.directive("overview",["$rootScope","$translate","$filter",function(e,o,t){return e.hideOverview=function(){e.overview=void 0},{restrict:"A",scope:!0,link:function(o,n){var s;n.css("cursor","help"),n.on("click",function(n){o.$apply(function(){o.$parent.ep&&!s&&(s=t("episodeInfo")(o.showInfo.episodes,o.$parent.ep)),e.overview={header:s?t("decimalFormat")(s.season)+"x"+t("decimalFormat")(s.number)+" - "+s.name:o.showId,content:s?s.overview:o.showInfo.tvShow.overview}}),window.scrollTo(0,0),n.preventDefault()})}}}]),subNode.directive("tooltip",["$parse",function(){return{restrict:"A",link:function(e,o,t){var n;e.$watch(function(){return o.attr("title")},function(e,s){!t.title||n&&e==s||(n=t.title,o.tooltip({title:t.title,placement:"top"}))})}}}]),subNode.filter("decimalFormat",function(){return function(e){return isNaN(e)?e:10>e?"0"+e:e}}),subNode.filter("episodeInfo",function(){return function(e,o){return e&&o?_.find(e,function(e){return e.season==o.season&&e.number==o.episode}):null}}),subNode.filter("localDate",["$filter","$translate",function(e,o){return function(t){return e("date")(t,o("DATE_FORMAT"))+" "+o("AT")+" "+e("date")(t,o("TIME_FORMAT"))}}]),subNode.filter("qualitySort",function(){var e;return function(o){return o&&e!==o?e=o.sort(function(e,o){return e.quality==o.quality?_.max(o.content,"score").score-_.max(e.content,"score").score:o.quality-e.quality}):o}}),subNode.filter("seasonFilter",function(){return function(e,o){return o?[_.find(e,function(e){return e.season==o})]:e}}),subNode.factory("$rest",["Restangular",function(e){var o=e.withConfig(function(e){e.setResponseExtractor(function(e){var o=e;return angular.isArray(e)?angular.forEach(o,function(e,t){o[t].originalElement=angular.copy(e)}):o.originalElement=angular.copy(e),o})});return o.clean=function(e){return _.omit(e,_.functions(e),["originalElement","parentResource","restangularCollection","route"])},o}]),subNode.config(["$translateProvider",function(e){e.useStaticFilesLoader({prefix:"i18n/locale-",suffix:".json"}),e.useLocalStorage();var o=navigator.language;e.preferredLanguage(/(fr|en)/gi.test(o)?o:"en"),e.translations()}]);